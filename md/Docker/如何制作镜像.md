## 制作镜像的N种方式

[TOC]

### 1、前言

制作镜像有很多种方法，包括导出导入也有很多不同，这里总结一下。

### 2、镜像制作

#### 2.1、Dcokerfile制作

以centos为例：

官方仓库下载的centos镜像，不带有"ll、wget、vim"等命令。我们制作镜像希望包括以上命令，并且在镜像内安装JDK1.8版本。

> 1、在/docker/centos目录下创建Dockerfile

~~~shell
[root@ centos]# touch Dockerfile
~~~

> 2、编辑Dockerfile

~~~dockerfile
from centos
ADD jdk-8u271-linux-x64.tar.gz /mnt
# 安装vim
RUN yum -y install vim \
    # 安装ll
    && echo "alias ll='ls $LS_OPTIONS -l'" >> ~/.bashrc \
    && source ~/.bashrc \
    # 安装wget
    && yum install -y  wget \
    # jdk
    && mv /mnt/jdk1.8.0_271 /opt/jdk \
    && echo "JAVA_HOME=/opt/jdk/" >> /etc/profile \
    && echo "JAVA_BIN=/opt/jdk/bin" >> /etc/profile \
    && echo "JRE_HOME=/opt/jdk/jre" >> /etc/profile \
    && echo "CLASSPATH=/opt/jdk/jre/lib:/opt/jdk/lib:/opt/jdk/jre/lib/charsets.jar" >> /etc/profile \
    && echo "export  JAVA_HOME  JAVA_BIN JRE_HOME  PATH  CLASSPATH" >> /etc/profile \
    && source /etc/profile \
    # 增加全局变量
    && echo "export JAVA_HOME=/opt/jdk" >> ~/.bashrc \
    && echo "export PATH=$JAVA_HOME/bin:$PATH" >> ~/.bashrc \
    && echo "export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar" >> ~/.bashrc \
    && source ~/.bashrc

~~~

注意：

`Dockerfile` 的指令每执行一次都会在 `docker` 上新建一层。所以过多无意义的层，会造成镜像膨胀过大。

如上，以 **&&** 符号连接命令，这样执行后，只会创建 1 层镜像。


> 3、下载jdk-8u271-linux-x64.tar.gz到当前目录

去[oracle官网下载JDK8](https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html)

> 4、开始构建镜像

在` Dockerfile` 文件的存放目录下，执行构建动作。

以下示例，通过目录下的 `Dockerfile` 构建一个 `my/centos`（镜像名称:镜像标签）。

**注**：最后的 **.** 代表本次执行的上下文路径，最好不要在当前上下文中，放太多无关的内容，否则会一起打包给docker引擎，造成过程缓慢

~~~shell
[root@ centos]# docker build -t my/centos .
Sending build context to Docker daemon  359.7MB
Step 1/3 : from centos
latest: Pulling from library/centos
7a0437f04f83: Pull complete
Digest: sha256:5528e8b1b1719d34604c87e11dcd1c0a20bedf46e83b5632cdeac91b8c04efc1
Status: Downloaded newer image for centos:latest
 ---> 300e315adb2f
Step 2/3 : ADD jdk-8u271-linux-x64.tar.gz /mnt
 ---> 318b8479f4cb
Step 3/3 : RUN yum -y install vim     && echo "alias ll='ls $LS_OPTIONS -l'" >> ~/.bashrc     && source ~/.bashrc     && yum install -y  wget     && mv /mnt/jdk1.8.0_271 /opt/jdk     && echo "JAVA_HOME=/opt/jdk/" >> /etc/profile     && echo "JAVA_BIN=/opt/jdk/bin" >> /etc/profile     && echo "JRE_HOME=/opt/jdk/jre" >> /etc/profile     && echo "CLASSPATH=/opt/jdk/jre/lib:/opt/jdk/lib:/opt/jdk/jre/lib/charsets.jar" >> /etc/profile     && echo "export  JAVA_HOME  JAVA_BIN JRE_HOME  PATH  CLASSPATH" >> /etc/profile     && source /etc/profile     && echo "export JAVA_HOME=/opt/jdk" >> ~/.bashrc     && echo "export PATH=$JAVA_HOME/bin:$PATH" >> ~/.bashrc     && echo "export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar" >> ~/.bashrc     && source ~/.bashrc
.....................                           
.....................
Complete!
Failed to set locale, defaulting to C.UTF-8
Removing intermediate container 713e31314b97
 ---> 5834b2cce45e
Successfully built 5834b2cce45e
Successfully tagged my/centos:latest
~~~

> 5、运行容器

~~~shell
[root@ centos]# docker run -itd --name centos-test -p 9090:8080 -v /home/project:/home/project  my/centos
~~~

> 6、进入容器

~~~shell
[root@ centos]# docker exec -it centos-test /bin/bash
~~~

> 7、测试各类命令

~~~shell
[root@0db2d25726e8 /]# ll
total 0
lrwxrwxrwx   1 root root   7 Nov  3 15:22 bin -> usr/bin
drwxr-xr-x   5 root root 360 Dec 10 01:48 dev
drwxr-xr-x   1 root root  66 Dec 10 01:48 etc
.......
[root@0db2d25726e8 /]# wget
wget: missing URL
Usage: wget [OPTION]... [URL]...

Try `wget --help' for more options.
[root@0db2d25726e8 /]# vim
~
~                                                                                     VIM - Vi IMproved
~
~                                                                                     version 8.0.1763
.....
[root@0db2d25726e8 /]# java -version
java version "1.8.0_271"
Java(TM) SE Runtime Environment (build 1.8.0_271-b09)
Java HotSpot(TM) 64-Bit Server VM (build 25.271-b09, mixed mode)
~~~

测试通过。

#### 2.2、人工操作

一般的过程就是一步步操作以上Dockerfile中的命令；

> 1、拉取centos镜像，运行容器

~~~~shell
[root@ centos]# docker pull centos
# 运行容器
[root@ centos]# docker run -itd --name centos-test centos
# 进入容器
[root@ centos]# docker exec -it centos-test /bin/bash
~~~~

> 2、安装 ll 命令

~~~shell
[root@3575121a0425 mnt]# echo "alias ll='ls $LS_OPTIONS -l'" >> ~/.bashrc
[root@3575121a0425 mnt]# source ~/.bashrc
~~~

> 3、退出出容器后，复制jdk到容器内

~~~shell
[root@0db2d25726e8 /]# exit
exit
[root@ centos]# docker cp jdk-8u271-linux-x64.tar.gz centos-test:/mnt
# 进入容器
[root@ centos]# docker exec -it centos-test /bin/bash
[root@3575121a0425 /]# ll mnt/
total 139788
-rw-r--r-- 1 root root 143142634 Dec  8 11:58 jdk-8u271-linux-x64.tar.gz
# 解压
[root@3575121a0425 mnt]# tar xzf jdk-8u271-linux-x64.tar.gz
[root@3575121a0425 mnt]# ll
total 139788
-rw-r--r-- 1 root  root  143142634 Dec  8 11:58 jdk-8u271-linux-x64.tar.gz
drwxr-xr-x 8 10143 10143       273 Sep 16 17:14 jdk1.8.0_271
# 移动到/opt/jdk
[root@3575121a0425 mnt]# mv jdk1.8.0_271 /opt/jdk
~~~

> 4、安装Vim

~~~shell
[root@3575121a0425 mnt]# yum -y install vim
~~~

> 5、安装wget

~~~shell
[root@3575121a0425 mnt]# yum install -y  wget
~~~

> 6、编辑 /etc/profile

~~~shell
[root@3575121a0425 mnt]# vim /etc/profile
# 增加以下内容
JAVA_HOME=/opt/jdk/
JAVA_BIN=/opt/jdk/bin
JRE_HOME=/opt/jdk/jre
CLASSPATH=/opt/jdk/jre/lib:/opt/jdk/lib:/opt/jdk/jre/lib/charsets.jar
export  JAVA_HOME  JAVA_BIN JRE_HOME  PATH  CLASSPATH
[root@3575121a0425 mnt]# source /etc/profile 
~~~

> 7、增加全局指令

~~~shell
[root@3575121a0425 mnt]# vim ~/.bashrc
# 增加以下内容
export JAVA_HOME=/opt/jdk
export PATH=$JAVA_HOME/bin:$PATH
export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
[root@3575121a0425 mnt]# source ~/.bashrc
~~~

> 8、测试

~~~shell
[root@3575121a0425 mnt]# java -version
java version "1.8.0_271"
Java(TM) SE Runtime Environment (build 1.8.0_271-b09)
Java HotSpot(TM) 64-Bit Server VM (build 25.271-b09, mixed mode)
~~~

### 3、容器导出

上一个步骤的容器制作完成后，导出操作可以让这个容器直接复制到其他机器上使用，减少人力成本。

#### 3.1、docker export

导出容器快照到本地文件

~~~shell
[root@ centos]# docker export centos-test > c.tar.gz
# 通过SSH发送到其他机器测试
[root@ centos]# scp c.tar.gz 192.168.66.99.*:/docker/centos
root@192.168.66.99's password:
c.tar.gz
~~~

> 192.168.66.99  机器

~~~shell
[root@2 centos]# ll
总用量 1094960
-rw-r--r-- 1 root root 1121223680 12月 10 10:56 c.tar.gz
# 导入并创建 test/centos 镜像
[root@2 centos]# docker import c.tar.gz test/centos
sha256:87b327bb365b81e5328e79df0d9bb04174a004afc4749d7caf32b756993394b2
[root@2 centos]# docker images
REPOSITORY           TAG                 IMAGE ID            CREATED             SIZE
test/centos          latest              87b327bb365b        42 seconds ago      1.11GB
# 运行容器
[root@2 centos]# docker run -itd --name centos-test -p 9090:8080 test/centos /bin/bash
# 进入容器
[root@2 centos]# docker exec -it centos-test /bin/bash
# 测试
[root@e3c130477d21 /]# java -version
java version "1.8.0_271"
Java(TM) SE Runtime Environment (build 1.8.0_271-b09)
Java HotSpot(TM) 64-Bit Server VM (build 25.271-b09, mixed mode)
~~~







